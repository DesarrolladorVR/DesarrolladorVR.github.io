<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*" />
    <title>ISTEduca - Pausa Saludable</title>
    <link rel="stylesheet" href="src/css/media.css" />
    <link rel="stylesheet" href="src/css/lighting_warning.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Lato:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" href="assets/images/ist.ico" />
  </head>
  <style>
    /* Critical CSS for Global Splash Screen */
    #globalSplash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #f5f7fa; /* Match app background */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    
    .splash-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(74, 49, 104, 0.2); /* purple-ist with opacity */
      border-radius: 50%;
      border-top-color: #C74398; /* pink-ist */
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .splash-text {
      font-family: 'Poppins', sans-serif;
      color: #4A3168; /* purple-ist */
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Critical CSS for Instant Loading Overlay (Existing - Optimized) */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      transition: opacity 0.5s ease;
      border-radius: 15px;
    }
    .loading-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      width: 100%;
    }
    .loading-icon {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #C74398; 
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 20px auto;
      will-change: transform;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      font-family: 'Poppins', sans-serif;
      font-size: 1.3rem;
      color: #4A3168; 
      margin-bottom: 10px;
      font-weight: 600;
    }
    .loading-subtext {
        font-family: 'Poppins', sans-serif;
        font-size: 0.9rem;
        color: #666;
    }
  </style>
  <body>
    <!-- Global Splash Screen -->
    <div id="globalSplash">
      <div class="splash-spinner"></div>
      <div class="splash-text">Cargando ISTEduca...</div> <!-- Optional: Add Logo here -->
    </div>
    
    <script>
      // El splash screen ahora es gestionado por script.js -> main()
      // para asegurar que solo desaparece cuando MediaPipe carga.
    </script>
    <div class="container">
      <!-- Audio para feedback -->
      <audio id="armsUpSound" preload="auto">
        <source src="assets/audio/arms-up-sound.wav" type="audio/wav" />
      </audio>

      <!-- Banner de advertencia para iframe (oculto por defecto, se muestra con JS) -->
      <div id="iframeBanner" class="iframe-banner" style="display: none">
        <div class="iframe-banner-content">
          <span class="iframe-banner-icon">‚ö†Ô∏è</span>
          <div class="iframe-banner-text">
            <strong>¬°Importante!</strong> Est√°s viendo esto dentro de Rise. Para
            usar la c√°mara, haz clic en el bot√≥n "Abrir en Nueva Ventana" abajo.
          </div>
          <button
            class="iframe-banner-close"
            onclick="this.parentElement.parentElement.style.display = 'none'"
          >
            √ó
          </button>
        </div>
      </div>

      <!-- Header con Logo -->
      <header class="header">
        <img
          src="assets/images/ist.png"
          class="logo"
          alt="Logotipo ISTEduca"
          loading="lazy"
        />
      </header>

      <!-- Sistema de Carga -->


      <!-- Contenido Principal -->
      <main id="mainContent" class="main-content">
        <!-- Bot√≥n Principal (oculto, c√°mara auto-inicia) -->
        <div class="camera-section" id="cameraSection" style="display: none">
          <button id="webcamButton" class="camera-button">
            <span class="button-icon">üì∑</span>
            <span class="button-text">Activar C√°mara</span>
          </button>
        </div>

        <!-- Vista de la C√°mara -->
        <div id="videoContainer" class="video-container hidden">
          <div class="camera-layout">
            <!-- COLUMNA IZQUIERDA: Video -->
            <div class="video-wrapper">
              <video id="webcam" autoplay playsinline></video>
              <canvas id="output_canvas"></canvas>

              <!-- Sistema de Carga (Integrado) -->
              <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-container">
                  <div class="loading-icon"></div>
                  <p class="loading-text" id="loadingText">Preparando c√°mara</p>
                  <p class="loading-subtext" id="loadingSubtext">
                    El navegador solicitar√° permiso para acceder a tu c√°mara.<br />Por
                    favor, <strong>acepta el permiso</strong> cuando aparezca.
                  </p>
                </div>
              </div>

              <!-- OVERLAY: Gu√≠as de Calibraci√≥n -->
              <div id="calibrationOverlay" class="calibration-overlay hidden">
                <div class="calibration-title">
                  üìè Ub√≠cate a 1 metro de la pantalla
                </div>

                <div class="calibration-guide face-guide">
                  <div class="guide-box"></div>
                  <div class="guide-label">Coloca tu ojos aqu√≠</div>
                </div>

                <div class="calibration-guide shoulder-guide">
                  <div class="guide-box"></div>
                  <div class="guide-label">Coloca tus hombros aqu√≠</div>
                </div>
              </div>

              <div id="validationOverlay" class="validation-overlay hidden">
                <div class="validation-label">Estado</div>
                <div class="validation-circle" id="validationCircle"></div>
              </div>

              <!-- OVERLAY: Barra de Progreso y UI Funcional -->
              <div id="progressOverlay" class="progress-overlay hidden">
                <div class="progress-container">
                  <div class="phase-info">
                    <span class="phase-icon" id="phaseIcon">üéØ</span>
                    <span class="phase-name" id="phaseName">Fase</span>
                  </div>

                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-bg">
                      <div
                        class="progress-bar-fill"
                        id="progressBarFill"
                        style="width: 0%"
                      ></div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">
                      0%
                    </div>
                  </div>

                  <div
                    class="hold-feedback"
                    id="holdFeedback"
                    style="display: none"
                  >
                    <div class="hold-text">Mant√©n la postura</div>
                    <div class="hold-timer" id="holdTimer">0s / 2s</div>
                  </div>

                  <div class="stats-bar">
                    <div class="stat-item">
                      <span class="stat-label">Confianza:</span>
                      <span class="stat-value" id="confidenceValue">0%</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">Pose:</span>
                      <span class="stat-value" id="poseValue">‚Äî</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- COLUMNA DERECHA: Panel de Calibraci√≥n -->
            <div
              class="calibration-panel"
              id="calibrationPanel"
              style="display: none"
            >
              <div class="panel-header">
                <h3>Calibraci√≥n</h3>
              </div>

              <div class="calibration-status" id="calibrationStatus">
                <div class="status-icon">‚è≥</div>
                <div class="status-text">Posici√≥nate en las gu√≠as</div>
              </div>

              <div class="calibration-instructions">
                <p><span class="icon">üìè</span> <span class="text">Ub√≠cate a <strong>1 metro</strong> de la pantalla</span></p>
                <p><span class="icon">üë§</span> <span class="text">Centra tu <strong>cara</strong> en el cuadro superior</span></p>
                <p><span class="icon">üí™</span> <span class="text">Centra tus <strong>hombros</strong> en el cuadro inferior</span></p>
                <p><span class="icon">‚è±Ô∏è</span> <span class="text">Mant√©n la posici√≥n <strong>2 segundos</strong></span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Texto de Guion / Subt√≠tulos -->
        <div id="subtitleText" class="subtitle-text"></div>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <p>üíú Desarrollado por ISTEduca - Todos juntos cuidandonos | 2026</p>
      </footer>
    </div>

    <script type="module" src="src/js/script.js"></script>
  </body>
</html>
